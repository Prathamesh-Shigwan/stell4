{% extends "custom_admin/base_site.html" %}

{% block content %}
<div class="container mt-5" style="border: 2px solid black; padding: 20px; border-radius: 8px;">
    <h2 class="mb-4 text-center" style="font-weight: 600; color: #343a40;">Customers</h2>

    {# Display Django's messages (e.g., for success after add/edit/delete) #}
    {% if messages %}
    <div class="container mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# Filters and Action Buttons Container - Responsive Layout #}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center mb-3 gap-3">
        {# Search & Filter Form #}
        <form method="GET" class="d-flex flex-column flex-md-row gap-2 mb-3 mb-md-0 flex-grow-1">
            <div class="input-group" style="max-width: 300px; width: 100%;">
                <input type="text" name="q" class="form-control" placeholder="Search by name or email" value="{{ query|default:'' }}"
                       style="border: 1px solid #ced4da; height:38px;">
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary" style="background-color: #007bff; border-color: #007bff; color: white;">Search</button>
                </div>
            </div>

            {# Status Filter Dropdown #}
            <select name="status" class="form-select" onchange="this.form.submit()"
                    style="border: 1px solid #ced4da; height: 38px; max-width: 200px;">
                <option value="">Filter by Status</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
            </select>

            {% if filters_active %}
                <a href="{% url 'custom_admin:customer_list' %}" class="btn btn-warning">Clear Filters</a>
            {% endif %}
        </form>

        {# Action Buttons #}
        <div class="d-flex flex-column flex-md-row justify-content-end gap-2">
            <a href="{% url 'custom_admin:add_customer' %}" class="btn btn-success w-100 w-md-auto" style="background-color: #28a745; border-color: #28a745; font-weight: bold;">Add Customer</a>
            <a href="#" class="btn btn-secondary w-100 w-md-auto" style="background-color: #6c757d; border-color: #6c757d; font-weight: bold; color: white;">Bulk Import</a>
        </div>
    </div>

    {# Table with responsive wrapper #}
    <div class="table-responsive">
        <table class="table table-striped" style="border: 1px solid black;">
            <thead class="table-dark" style="background-color: #343a40; color: white;">
                <tr>
                    <th scope="col" style="border: 1px solid black;">
                        <a href="?sort_by=username{% if sort_by == 'username' and order == 'asc' %}&order=desc{% else %}&order=asc{% endif %}{% if query %}&q={{ query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           style="text-decoration: none; color: inherit;">
                            Username
                            {% if sort_by == 'username' %}{% if order == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                        </a>
                    </th>
                    <th scope="col" style="border: 1px solid black;">Email</th>
                    <th scope="col" style="border: 1px solid black;">Phone</th>
                    <th scope="col" style="border: 1px solid black;">Status</th>
                    <th scope="col" style="border: 1px solid black;">
                        <a href="?sort_by=last_login{% if sort_by == 'last_login' and order == 'asc' %}&order=desc{% else %}&order=asc{% endif %}{% if query %}&q={{ query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           style="text-decoration: none; color: inherit;">
                            Last Login
                            {% if sort_by == 'last_login' %}{% if order == 'asc' %}&uarr;{% else %}&darr;{% endif %}{% endif %}
                        </a>
                    </th>
                    <th scope="col" style="border: 1px solid black;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td style="border: 1px solid black;">{{ customer.username }}</td>
                    <td style="border: 1px solid black; word-wrap: break-word;">{{ customer.email }}</td>
                    <td style="border: 1px solid black;">{{ customer.profile.phone|default:"N/A" }}</td>
                    <td style="border: 1px solid black;">
                        {% if customer.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                             <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </td>
                    <td style="border: 1px solid black;">{{ customer.last_login|date:"Y-m-d H:i"|default:"Never" }}</td>
                    <td style="border: 1px solid black;">
                        <div class="d-flex flex-wrap gap-1">
                            <a href="{% url 'custom_admin:edit_customer' customer.pk %}" class="btn btn-sm btn-primary">Edit</a>

                            <form action="{% url 'custom_admin:delete_customer' customer.pk %}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this customer?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>

                            <a href="{% url 'custom_admin:send_reengagement_email' customer.id %}" class="btn btn-sm btn-warning text-dark">
                                Send Reminder
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center" style="border: 1px solid black;">
                        {% if filters_active %}
                            No customers found matching your applied filters.
                        {% else %}
                            No customers are available.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}